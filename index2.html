<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Improved Liquidity Withdraw dApp</title>
    <!-- jQuery and ethers (we use ethers only, no web3.js) -->
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    
    <!-- The code below uses ES modules so modern browsers are required -->
    <script type="module">
      /********************************************
       * Global State & Provider Discovery
       ********************************************/
      let defaultProvider = null;         // For default (window.ethereum) connection
      let selectedProvider = null;        // Currently “active” provider (injected or via EIP‑6963)
      let signer = null;                  // Ethers signer for sending transactions
      let userAddress = null;             // The currently connected address
      let eip6963Providers = [];          // Array of discovered EIP‑6963 provider details
      let currentEIP6963Index = null;     // Index of the currently selected EIP‑6963 provider

      // Listen for EIP-6963 announcement events and store discovered providers.
      window.addEventListener("eip6963:announceProvider", (event) => {
        console.log("EIP6963 provider announced:", event.detail.info);
        eip6963Providers.push(event.detail);
      });
      // Ask for providers to announce themselves (per EIP-6963)
      window.dispatchEvent(new Event("eip6963:requestProvider"));

      // A simple delay helper (used later to delay batch calls)
      const delay = ms => new Promise(resolve => setTimeout(resolve, ms));


      /********************************************
       * Wallet Connection Functions
       ********************************************/

      // Connect the “default” injected wallet (e.g. MetaMask)
      async function connectDefaultWallet() {
        if (!window.ethereum) {
          alert("Please install a web3 wallet (e.g. MetaMask)!");
          return;
        }
        try {
          // Request accounts using the modern API:
          const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
          defaultProvider = new ethers.providers.Web3Provider(window.ethereum);
          signer = defaultProvider.getSigner();
          userAddress = accounts[0];
          selectedProvider = window.ethereum; // Save the provider for later (for chain switching)
          $("#connect-wallet").text(userAddress);
          $("#checkAcct").prop("disabled", false);
        } catch (error) {
          console.error("Failed to connect wallet:", error);
          alert("Wallet connection failed.");
        }
      }

      // Connect using one of the EIP-6963 providers (picked via a modal)
      async function connectEIP6963Wallet(providerDetail) {
        try {
          const ethersProvider = new ethers.providers.Web3Provider(providerDetail.provider);
          const accounts = await providerDetail.provider.request({ method: "eth_requestAccounts" });
          signer = ethersProvider.getSigner();
          userAddress = accounts[0];
          selectedProvider = providerDetail.provider;
          currentEIP6963Index = eip6963Providers.findIndex(p => p.info.uuid === providerDetail.info.uuid);
          console.log("Connected via EIP6963:", userAddress);
          $("#connect-other-wallets").text("Disconnect");
          $("#checkAcct").prop("disabled", false);
        } catch (error) {
          console.error("Failed to connect EIP6963 wallet:", error);
          alert("EIP6963 wallet connection failed.");
        }
      }

      // Disconnect current wallet and reset UI state
      function disconnectWallet() {
        selectedProvider = null;
        signer = null;
        userAddress = null;
        currentEIP6963Index = null;
        $("#connect-wallet").text("Connect Wallet");
        $("#connect-other-wallets").text("Other wallets");
        $("#checkAcct").prop("disabled", true);
      }


      /********************************************
       * Chain Switching Utility
       ********************************************/
      // Attempt to switch chains using the provider’s API. If unsuccessful,
      // notify the user. (You might extend this by calling wallet_addEthereumChain.)
      async function switchChain(targetChainId) {
        // targetChainId should be a hex string (e.g. "0x1" for Ethereum Mainnet, "0x38" for BSC)
        if (!selectedProvider) {
          throw new Error("No provider connected");
        }
        try {
          await selectedProvider.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: targetChainId }]
          });
          console.log("Switched to chain:", targetChainId);
        } catch (error) {
          // 4902 indicates the chain has not been added to the wallet
          if (error.code === 4902) {
            alert("The requested chain is not available in your wallet. Please add it manually.");
          } else {
            console.error("Chain switch error:", error);
            alert("Failed to switch chain. Please switch manually in your wallet.");
          }
          throw error;
        }
      }


      /********************************************
       * Transaction Functions
       ********************************************/
      // Withdraw liquidity from a contract.
      // Before calling the withdraw function the code attempts a chain switch.
      async function withdrawLiquidity(contractAddress, amount, chainId) {
        // Map known chain numbers to hex values.
        const chainMap = {
          "1": "0x1",   // Ethereum Mainnet
          "56": "0x38"  // Binance Smart Chain
        };
        const targetChain = chainMap[chainId];
        if (!targetChain) {
          console.error("Unsupported chain:", chainId);
          return;
        }
        try {
          // Attempt to switch chain.
          await switchChain(targetChain);
          // Reinitialize the provider and signer after chain switching.
          if (selectedProvider) {
            const ethersProvider = new ethers.providers.Web3Provider(selectedProvider);
            signer = ethersProvider.getSigner();
          } else {
            console.error("No provider available after chain switch");
            return;
          }
          // Define the ABI for the withdraw function.
          const abi = [
            "function withdraw(uint256 amount, uint256[] minReturns)"
          ];
          const contract = new ethers.Contract(contractAddress, abi, signer);
          console.log("Calling withdraw with:", { to: contractAddress, amount, minReturns: [0, 0] });
          const tx = await contract.withdraw(amount, [0, 0]);
          console.log("Transaction submitted:", tx);
          await tx.wait();
          alert("Withdrawal successful!");
        } catch (error) {
          console.error("Withdrawal failed:", error);
          alert("Withdrawal failed. Check the console for details.");
        }
      }

      // Exit a farming contract (example function).
      async function exitFarming(contractAddress) {
        try {
          if (selectedProvider) {
            const ethersProvider = new ethers.providers.Web3Provider(selectedProvider);
            signer = ethersProvider.getSigner();
          } else {
            console.error("No provider connected");
            return;
          }
          // Supply your farming contract ABI here.
          const FARMING_ABI = [ /* YOUR FARMING ABI HERE */ ];
          const contract = new ethers.Contract(contractAddress, FARMING_ABI, signer);
          console.log("Calling exit on farming contract:", contractAddress);
          const tx = await contract.exit();
          console.log("Exit transaction:", tx);
          await tx.wait();
          alert("Exited farming successfully!");
        } catch (error) {
          console.error("Exit farming failed:", error);
          alert("Exiting farming failed. See console for details.");
        }
      }


      /********************************************
       * Multicall Helpers
       ********************************************/
      // Process the result of a multicall batch and add rows to the table.
      function processMulticallResults(result, batch, chainId) {
        // result is assumed to be [blockNumber, returnDataArray]
        const returnData = result[1];
        returnData.forEach((data, index) => {
          // Only show tokens with a nonzero result.
          if (BigInt(data && data) !== 0n) {
            const tokenAddress = batch[index].target;
            const balance = BigInt(data).toString();
            // Create a table row using jQuery.
            const row = $(`
              <tr>
                <td>${tokenAddress}</td>
                <td>${balance}</td>
                <td>
                  <button class="withdraw-btn"
                          data-target="${tokenAddress}"
                          data-amount="${data}"
                          data-chain="${chainId}">
                    Withdraw
                  </button>
                </td>
              </tr>
            `);
            $("#tbody").append(row);
          }
        });
      }

      // Handle multicall batches. (This example uses delays to avoid rate limiting.)
      async function handleMulticalls(batchIndex, multicallContractETH, multicallContractBSC, allETHPools, allBNBPools, allEthOnePointOhPools, usrAddress) {
        const batchSize = 100;
        const batchETH = [];
        const batchBNB = [];
        const batchETHOnePointOh = [];

        for (let j = 1; j <= batchSize; j++) {
          const idx = batchIndex * batchSize + j;
          if (allETHPools[idx]) {
            batchETH.push({
              target: allETHPools[idx],
              allowFailure: true,
              callData: "0x70a08231000000000000000000000000" + usrAddress.substring(2)
            });
          }
          if (allBNBPools[idx]) {
            batchBNB.push({
              target: allBNBPools[idx],
              allowFailure: true,
              callData: "0x70a08231000000000000000000000000" + usrAddress.substring(2)
            });
          }
          if (allEthOnePointOhPools[idx]) {
            batchETHOnePointOh.push({
              target: allEthOnePointOhPools[idx],
              allowFailure: true,
              callData: "0x70a08231000000000000000000000000" + usrAddress.substring(2)
            });
          }
        }
        // Delay each batch to avoid rate limiting.
        await delay(batchIndex * 5000);
        if (batchETH.length > 0) {
          multicallContractETH.callStatic.aggregate(batchETH)
            .then(result => processMulticallResults(result, batchETH, "1"))
            .catch(err => console.error("Multicall ETH error:", err));
        }
        if (batchBNB.length > 0) {
          multicallContractBSC.callStatic.aggregate(batchBNB)
            .then(result => processMulticallResults(result, batchBNB, "56"))
            .catch(err => console.error("Multicall BSC error:", err));
        }
        if (batchETHOnePointOh.length > 0) {
          multicallContractETH.callStatic.aggregate(batchETHOnePointOh)
            .then(result => processMulticallResults(result, batchETHOnePointOh, "1"))
            .catch(err => console.error("Multicall ETH 1.0 error:", err));
        }
      }

      // An example function to check the user’s farming positions.
      async function checkAndModifyFarming(usrAddress) {
        // List of farming contract addresses (update with your own)
        const FARMS = [
                  // v1.0
                  "0x13927A60c7bf4d3d00E3C1593E0Ec713E35d2106",
                  "0xd7936052d1e096d48c81ef3918f9fd6384108480",
                  "0x302a6eda4e2b2c563a80cc17bd80a1251b986677",
                  "0x2ec255797fef7669fa243509b7a599121148ffba",
                  "0x94bc2a1c732bcad7343b25af48385fe76e08734f",
                  "0xa218543cc21ee9388fa1e509f950fd127ca82155",
                  // v1.1
                  "0xd7012cdebf10d5b352c601563aa3a8d1795a3f52",
                  "0x98484d4259a70b73af58180521f2eb71a3f00ae6",
                  "0xa83fcea9229c7f1e02acb46abe8d6889259339e8",
                  "0x0da1b305d7101359434d71eceaab71e1ff5437e6",
                  "0x4dab1ba9609c1546a0a69a76f00ed935b0b9c45e",
                  "0x9070832cf729a5150bb26825c2927e7d343eabd9",
                  "0xe22f6a5dd9e491dfab49faefdb32d01aaf99703e",
                  "0xca6e3ebf4ac8c3e84bccdf5cd89aece74d69f2a7",
                  "0xc7c42eccac0d4bb790a32bc86519ac362e01d388",
                  "0x2ede375d73d81dbd19ef58a75ba359dd28d25de8",
                  "0x8acdb3bcc5101b1ba8a5070f003a77a2da376fe8",
                  "0x18d410f651289bb978fc32f90d2d7e608f4f4560",
                  "0x7cb203834ce6792756541d722d94296f4c1ca356",
                  "0xc84dcdaff87f9b5639db82f434c8ba1c2023f6eb",
                  "0xeb7dbc5a64d2d083d774595e560b147c5021eacd",
                  "0xa355b4b904ce09bd1847f4cf133769bc0dfbc51b",
                  "0x8ba0ef03c26fa2a11bde30db4e87c87408b9761b",
                  "0x7ded1b278d244f707214759c45c1540834890e95",
                  "0x8b1af1298f5c0ca8a6b4e66626a4bdae0f7521e5",
                  "0x48371588e964f1e8939127af68622e32268640fa",
                  "0x950a9414700e8ee8041c1cab5a0c6afddf0e9257",
                  "0x2cb9e71a5cf989008ba93dad8edb988ec1b4182f",
                  "0x598032ba8e7acb625ea6854b4696e25afa2ec9f0",
                  "0x73f5e5260423a2742d9f8ac49dea6cb5eaec465e",
                  "0x1055f60bbf27d233c4e34d2e03e35567427415fa",
                  "0xe65184b402376703adc27a7d7e0e8d35a264a240",
                  "0xd7012cdebf10d5b352c601563aa3a8d1795a3f52",
              ]
        const FARMING_ABI = [{"inputs":[{"internalType":"contract Mooniswap","name":"_mooniswap","type":"address"},{"internalType":"contract IERC20","name":"_gift","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"decayPeriod","type":"uint256"},{"indexed":false,"internalType":"bool","name":"isDefault","type":"bool"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"DecayPeriodVoteUpdate","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"fee","type":"uint256"},{"indexed":false,"internalType":"bool","name":"isDefault","type":"bool"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FeeVoteUpdate","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"reward","type":"uint256"}],"name":"RewardAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"reward","type":"uint256"}],"name":"RewardPaid","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"slippageFee","type":"uint256"},{"indexed":false,"internalType":"bool","name":"isDefault","type":"bool"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"SlippageFeeVoteUpdate","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Staked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Withdrawn","type":"event"},{"inputs":[],"name":"DURATION","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decayPeriod","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"vote","type":"uint256"}],"name":"decayPeriodVote","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"decayPeriodVotes","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"discardDecayPeriodVote","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"discardFeeVote","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"discardSlippageFeeVote","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"earned","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"exit","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"fee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"vote","type":"uint256"}],"name":"feeVote","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"feeVotes","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getReward","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"gift","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lastTimeRewardApplicable","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lastUpdateTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"mooniswap","outputs":[{"internalType":"contract Mooniswap","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"mooniswapFactoryGovernance","outputs":[{"internalType":"contract IMooniswapFactoryGovernance","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"reward","type":"uint256"}],"name":"notifyRewardAmount","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"periodFinish","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"rewardDistribution","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"rewardPerToken","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"rewardPerTokenStored","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"rewardRate","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"rewards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_rewardDistribution","type":"address"}],"name":"setRewardDistribution","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"slippageFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"vote","type":"uint256"}],"name":"slippageFeeVote","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"slippageFeeVotes","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"stake","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"userRewardPerTokenPaid","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"}];
        const farmIface = new ethers.utils.Interface(FARMING_ABI);
        const balanceOfCalldata = farmIface.encodeFunctionData("balanceOf", [usrAddress]);
        const tempEthereumv1RpcUrl = $('#ethRPCv1').val();
        const providerv1 = new ethers.providers.JsonRpcProvider(tempEthereumv1RpcUrl);

        for (let i = 0; i < FARMS.length; i++) {
          try {
            const result = await providerv1.call({
              to: FARMS[i],
              data: balanceOfCalldata
            });
            if (BigInt(result && result) !== 0n) {
              const balance = BigInt(result).toString();
              const row = $(`
                <tr>
                  <td>${FARMS[i]}</td>
                  <td>${balance}</td>
                  <td>
                    <button class="exit-farming-btn" data-target="${FARMS[i]}">Withdraw</button>
                  </td>
                </tr>
              `);
              $("#tbody").append(row);
            }
          } catch (error) {
            console.error(`Error checking farm ${FARMS[i]}:`, error);
          }
        }
      }


      /********************************************
       * jQuery UI & Event Listeners
       ********************************************/
      $(document).ready(() => {
        // Initially disable the “Check For Liquidity” button.
        $("#checkAcct").prop("disabled", true);

        // Connect using the default injected provider.
        $("#connect-wallet").on("click", async (e) => {
          e.preventDefault();
          // Toggle connection: if already connected, disconnect.
          if (userAddress) {
            disconnectWallet();
          } else {
            await connectDefaultWallet();
          }
        });

        // Connect using another wallet (EIP‑6963).
        $("#connect-other-wallets").on("click", async (e) => {
          e.preventDefault();
          // If already connected via an EIP‑6963 wallet, disconnect.
          if (userAddress && currentEIP6963Index !== null) {
            disconnectWallet();
            return;
          }
          if (eip6963Providers.length === 0) {
            alert("No alternative wallets found.");
            return;
          }
          // Build a simple modal that lists each discovered provider.
          const modal = $("<div>", { id: "walletModal" }).css({
            position: "fixed",
            top: "20%",
            left: "50%",
            transform: "translate(-50%, -50%)",
            width: "100%",
            "max-width": "400px",
            border: "1px solid black",
            "border-radius": "5px",
            background: "white",
            padding: "10px",
            zIndex: 1000
          });
          eip6963Providers.forEach((prov) => {
            const provDiv = $("<div>").css({
              display: "flex",
              flexDirection: "row",
              alignItems: "center",
              justifyContent: "center",
              width: "100%",
              height: "50px",
              borderBottom: "1px solid black",
              cursor: "pointer"
            });
            const img = $("<img>").attr("src", prov.info.icon).css({
              width: "25px",
              height: "25px",
              objectFit: "contain"
            });
            const nameP = $("<p>").text(prov.info.name).css({ marginLeft: "10px" });
            provDiv.append(img, nameP);
            provDiv.on("click", async () => {
              await connectEIP6963Wallet(prov);
              modal.remove();
            });
            modal.append(provDiv);
          });
          const closeButton = $("<button>")
            .text("Close")
            .on("click", () => modal.remove());
          modal.append(closeButton);
          $("body").append(modal);
        });

        // “Check For Liquidity” button: run your multicall queries and other checks.
        $("#checkAcct").on("click", async (e) => {
          e.preventDefault();
          $("#loadingModal").show();
          if (!userAddress) {
            alert("No wallet connected.");
            $("#loadingModal").hide();
            return;
          }
          // Optionally call your staking check here:
          // checkAndModifyStaking(userAddress);

          await checkAndModifyFarming(userAddress);

          // Get RPC URLs from the inputs.
          const ethRPC = $('#ethRPC').val();
          const ethRPCv1 = $('#ethRPCv1').val();
          const bnbRPC = $('#bnbRPC').val();

          // Example factory addresses and ABIs (update with your values).
          const BNBPoolFactory = "0xD41B24bbA51fAc0E4827b6F94C0D6DDeB183cD64";
          const ETHPoolFactory = "0xbAF9A5d4b0052359326A6CDAb54BABAa3a3A9643";
          const ETHPoolFactoryV1point0 = "0xC4A8B7e29E3C8ec560cd4945c1cF3461a85a148d";
          const FACTORY_ABI = [{ "inputs": [{ "internalType": "address", "name": "_poolOwner", "type": "address" }, { "internalType": "contract IMooniswapDeployer", "name": "_mooniswapDeployer", "type": "address" }, { "internalType": "address", "name": "_governanceMothership", "type": "address" }], "stateMutability": "nonpayable", "type": "constructor" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "user", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "decayPeriod", "type": "uint256" }, { "indexed": false, "internalType": "bool", "name": "isDefault", "type": "bool" }, { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "DefaultDecayPeriodVoteUpdate", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "user", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "fee", "type": "uint256" }, { "indexed": false, "internalType": "bool", "name": "isDefault", "type": "bool" }, { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "DefaultFeeVoteUpdate", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "user", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "slippageFee", "type": "uint256" }, { "indexed": false, "internalType": "bool", "name": "isDefault", "type": "bool" }, { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "DefaultSlippageFeeVoteUpdate", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "contract Mooniswap", "name": "mooniswap", "type": "address" }, { "indexed": true, "internalType": "contract IERC20", "name": "token1", "type": "address" }, { "indexed": true, "internalType": "contract IERC20", "name": "token2", "type": "address" }], "name": "Deployed", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "address", "name": "feeCollector", "type": "address" }], "name": "FeeCollectorUpdate", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "user", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "governanceShare", "type": "uint256" }, { "indexed": false, "internalType": "bool", "name": "isDefault", "type": "bool" }, { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "GovernanceShareVoteUpdate", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "address", "name": "governanceWallet", "type": "address" }], "name": "GovernanceWalletUpdate", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "previousOwner", "type": "address" }, { "indexed": true, "internalType": "address", "name": "newOwner", "type": "address" }], "name": "OwnershipTransferred", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "address", "name": "account", "type": "address" }], "name": "Paused", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "user", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "referralShare", "type": "uint256" }, { "indexed": false, "internalType": "bool", "name": "isDefault", "type": "bool" }, { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "ReferralShareVoteUpdate", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "address", "name": "account", "type": "address" }], "name": "Unpaused", "type": "event" }, { "inputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "name": "allPools", "outputs": [{ "internalType": "contract Mooniswap", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }], "name": "balanceOf", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "defaultDecayPeriod", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "vote", "type": "uint256" }], "name": "defaultDecayPeriodVote", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "user", "type": "address" }], "name": "defaultDecayPeriodVotes", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "defaultFee", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "vote", "type": "uint256" }], "name": "defaultFeeVote", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "user", "type": "address" }], "name": "defaultFeeVotes", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "defaultSlippageFee", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "vote", "type": "uint256" }], "name": "defaultSlippageFeeVote", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "user", "type": "address" }], "name": "defaultSlippageFeeVotes", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "defaults", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }, { "internalType": "uint256", "name": "", "type": "uint256" }, { "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "contract IERC20", "name": "tokenA", "type": "address" }, { "internalType": "contract IERC20", "name": "tokenB", "type": "address" }], "name": "deploy", "outputs": [{ "internalType": "contract Mooniswap", "name": "pool", "type": "address" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "discardDefaultDecayPeriodVote", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "discardDefaultFeeVote", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "discardDefaultSlippageFeeVote", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "discardGovernanceShareVote", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "discardReferralShareVote", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "feeCollector", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getAllPools", "outputs": [{ "internalType": "contract Mooniswap[]", "name": "", "type": "address[]" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "governanceShare", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "vote", "type": "uint256" }], "name": "governanceShareVote", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "user", "type": "address" }], "name": "governanceShareVotes", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "governanceWallet", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "isActive", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "", "type": "address" }], "name": "isFeeCollector", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "contract Mooniswap", "name": "", "type": "address" }], "name": "isPool", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "mooniswapDeployer", "outputs": [{ "internalType": "contract IMooniswapDeployer", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "mothership", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }, { "internalType": "uint256", "name": "newBalance", "type": "uint256" }], "name": "notifyStakeChanged", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address[]", "name": "accounts", "type": "address[]" }, { "internalType": "uint256[]", "name": "newBalances", "type": "uint256[]" }], "name": "notifyStakesChanged", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "owner", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "paused", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "poolOwner", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "contract IERC20", "name": "tokenA", "type": "address" }, { "internalType": "contract IERC20", "name": "tokenB", "type": "address" }], "name": "pools", "outputs": [{ "internalType": "contract Mooniswap", "name": "pool", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "referralShare", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "vote", "type": "uint256" }], "name": "referralShareVote", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "user", "type": "address" }], "name": "referralShareVotes", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "renounceOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "newFeeCollector", "type": "address" }], "name": "setFeeCollector", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "newGovernanceWallet", "type": "address" }], "name": "setGovernanceWallet", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "shareParameters", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }, { "internalType": "uint256", "name": "", "type": "uint256" }, { "internalType": "address", "name": "", "type": "address" }, { "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "shutdown", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "contract IERC20", "name": "tokenA", "type": "address" }, { "internalType": "contract IERC20", "name": "tokenB", "type": "address" }], "name": "sortTokens", "outputs": [{ "internalType": "contract IERC20", "name": "", "type": "address" }, { "internalType": "contract IERC20", "name": "", "type": "address" }], "stateMutability": "pure", "type": "function" }, { "inputs": [], "name": "totalSupply", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "newOwner", "type": "address" }], "name": "transferOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "virtualDefaultDecayPeriod", "outputs": [{ "internalType": "uint104", "name": "", "type": "uint104" }, { "internalType": "uint104", "name": "", "type": "uint104" }, { "internalType": "uint48", "name": "", "type": "uint48" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "virtualDefaultFee", "outputs": [{ "internalType": "uint104", "name": "", "type": "uint104" }, { "internalType": "uint104", "name": "", "type": "uint104" }, { "internalType": "uint48", "name": "", "type": "uint48" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "virtualDefaultSlippageFee", "outputs": [{ "internalType": "uint104", "name": "", "type": "uint104" }, { "internalType": "uint104", "name": "", "type": "uint104" }, { "internalType": "uint48", "name": "", "type": "uint48" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "virtualGovernanceShare", "outputs": [{ "internalType": "uint104", "name": "", "type": "uint104" }, { "internalType": "uint104", "name": "", "type": "uint104" }, { "internalType": "uint48", "name": "", "type": "uint48" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "virtualReferralShare", "outputs": [{ "internalType": "uint104", "name": "", "type": "uint104" }, { "internalType": "uint104", "name": "", "type": "uint104" }, { "internalType": "uint48", "name": "", "type": "uint48" }], "stateMutability": "view", "type": "function" }];
          const POOL_ABI = [{ "inputs": [{ "internalType": "contract IERC20", "name": "_token0", "type": "address" }, { "internalType": "contract IERC20", "name": "_token1", "type": "address" }, { "internalType": "string", "name": "name", "type": "string" }, { "internalType": "string", "name": "symbol", "type": "string" }, { "internalType": "contract IMooniswapFactoryGovernance", "name": "_mooniswapFactoryGovernance", "type": "address" }], "stateMutability": "nonpayable", "type": "constructor" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "owner", "type": "address" }, { "indexed": true, "internalType": "address", "name": "spender", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "Approval", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "user", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "decayPeriod", "type": "uint256" }, { "indexed": false, "internalType": "bool", "name": "isDefault", "type": "bool" }, { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "DecayPeriodVoteUpdate", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "sender", "type": "address" }, { "indexed": true, "internalType": "address", "name": "receiver", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "share", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "token0Amount", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "token1Amount", "type": "uint256" }], "name": "Deposited", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "string", "name": "reason", "type": "string" }], "name": "Error", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "user", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "fee", "type": "uint256" }, { "indexed": false, "internalType": "bool", "name": "isDefault", "type": "bool" }, { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "FeeVoteUpdate", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "previousOwner", "type": "address" }, { "indexed": true, "internalType": "address", "name": "newOwner", "type": "address" }], "name": "OwnershipTransferred", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "user", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "slippageFee", "type": "uint256" }, { "indexed": false, "internalType": "bool", "name": "isDefault", "type": "bool" }, { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "SlippageFeeVoteUpdate", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "sender", "type": "address" }, { "indexed": true, "internalType": "address", "name": "receiver", "type": "address" }, { "indexed": true, "internalType": "address", "name": "srcToken", "type": "address" }, { "indexed": false, "internalType": "address", "name": "dstToken", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "result", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "srcAdditionBalance", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "dstRemovalBalance", "type": "uint256" }, { "indexed": false, "internalType": "address", "name": "referral", "type": "address" }], "name": "Swapped", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "uint256", "name": "srcBalance", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "dstBalance", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "fee", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "slippageFee", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "referralShare", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "governanceShare", "type": "uint256" }], "name": "Sync", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "from", "type": "address" }, { "indexed": true, "internalType": "address", "name": "to", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "Transfer", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "sender", "type": "address" }, { "indexed": true, "internalType": "address", "name": "receiver", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "share", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "token0Amount", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "token1Amount", "type": "uint256" }], "name": "Withdrawn", "type": "event" }, { "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }, { "internalType": "address", "name": "spender", "type": "address" }], "name": "allowance", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "approve", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }], "name": "balanceOf", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "decayPeriod", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "vote", "type": "uint256" }], "name": "decayPeriodVote", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "user", "type": "address" }], "name": "decayPeriodVotes", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "decimals", "outputs": [{ "internalType": "uint8", "name": "", "type": "uint8" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "subtractedValue", "type": "uint256" }], "name": "decreaseAllowance", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "uint256[2]", "name": "maxAmounts", "type": "uint256[2]" }, { "internalType": "uint256[2]", "name": "minAmounts", "type": "uint256[2]" }], "name": "deposit", "outputs": [{ "internalType": "uint256", "name": "fairSupply", "type": "uint256" }, { "internalType": "uint256[2]", "name": "receivedAmounts", "type": "uint256[2]" }], "stateMutability": "payable", "type": "function" }, { "inputs": [{ "internalType": "uint256[2]", "name": "maxAmounts", "type": "uint256[2]" }, { "internalType": "uint256[2]", "name": "minAmounts", "type": "uint256[2]" }, { "internalType": "address", "name": "target", "type": "address" }], "name": "depositFor", "outputs": [{ "internalType": "uint256", "name": "fairSupply", "type": "uint256" }, { "internalType": "uint256[2]", "name": "receivedAmounts", "type": "uint256[2]" }], "stateMutability": "payable", "type": "function" }, { "inputs": [], "name": "discardDecayPeriodVote", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "discardFeeVote", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "discardSlippageFeeVote", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "fee", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "vote", "type": "uint256" }], "name": "feeVote", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "user", "type": "address" }], "name": "feeVotes", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "contract IERC20", "name": "token", "type": "address" }], "name": "getBalanceForAddition", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "contract IERC20", "name": "token", "type": "address" }], "name": "getBalanceForRemoval", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "contract IERC20", "name": "src", "type": "address" }, { "internalType": "contract IERC20", "name": "dst", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "getReturn", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getTokens", "outputs": [{ "internalType": "contract IERC20[]", "name": "tokens", "type": "address[]" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "addedValue", "type": "uint256" }], "name": "increaseAllowance", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "mooniswapFactoryGovernance", "outputs": [{ "internalType": "contract IMooniswapFactoryGovernance", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "name", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "owner", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "renounceOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "contract IERC20", "name": "token", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "rescueFunds", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "contract IMooniswapFactoryGovernance", "name": "newMooniswapFactoryGovernance", "type": "address" }], "name": "setMooniswapFactoryGovernance", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "slippageFee", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "vote", "type": "uint256" }], "name": "slippageFeeVote", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "user", "type": "address" }], "name": "slippageFeeVotes", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "contract IERC20", "name": "src", "type": "address" }, { "internalType": "contract IERC20", "name": "dst", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }, { "internalType": "uint256", "name": "minReturn", "type": "uint256" }, { "internalType": "address", "name": "referral", "type": "address" }], "name": "swap", "outputs": [{ "internalType": "uint256", "name": "result", "type": "uint256" }], "stateMutability": "payable", "type": "function" }, { "inputs": [{ "internalType": "contract IERC20", "name": "src", "type": "address" }, { "internalType": "contract IERC20", "name": "dst", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }, { "internalType": "uint256", "name": "minReturn", "type": "uint256" }, { "internalType": "address", "name": "referral", "type": "address" }, { "internalType": "address payable", "name": "receiver", "type": "address" }], "name": "swapFor", "outputs": [{ "internalType": "uint256", "name": "result", "type": "uint256" }], "stateMutability": "payable", "type": "function" }, { "inputs": [], "name": "symbol", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "token0", "outputs": [{ "internalType": "contract IERC20", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "token1", "outputs": [{ "internalType": "contract IERC20", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "i", "type": "uint256" }], "name": "tokens", "outputs": [{ "internalType": "contract IERC20", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "totalSupply", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "recipient", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "transfer", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "sender", "type": "address" }, { "internalType": "address", "name": "recipient", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "transferFrom", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "newOwner", "type": "address" }], "name": "transferOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "contract IERC20", "name": "", "type": "address" }], "name": "virtualBalancesForAddition", "outputs": [{ "internalType": "uint216", "name": "balance", "type": "uint216" }, { "internalType": "uint40", "name": "time", "type": "uint40" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "contract IERC20", "name": "", "type": "address" }], "name": "virtualBalancesForRemoval", "outputs": [{ "internalType": "uint216", "name": "balance", "type": "uint216" }, { "internalType": "uint40", "name": "time", "type": "uint40" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "virtualDecayPeriod", "outputs": [{ "internalType": "uint104", "name": "", "type": "uint104" }, { "internalType": "uint104", "name": "", "type": "uint104" }, { "internalType": "uint48", "name": "", "type": "uint48" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "virtualFee", "outputs": [{ "internalType": "uint104", "name": "", "type": "uint104" }, { "internalType": "uint104", "name": "", "type": "uint104" }, { "internalType": "uint48", "name": "", "type": "uint48" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "virtualSlippageFee", "outputs": [{ "internalType": "uint104", "name": "", "type": "uint104" }, { "internalType": "uint104", "name": "", "type": "uint104" }, { "internalType": "uint48", "name": "", "type": "uint48" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "contract IERC20", "name": "", "type": "address" }], "name": "volumes", "outputs": [{ "internalType": "uint128", "name": "confirmed", "type": "uint128" }, { "internalType": "uint128", "name": "result", "type": "uint128" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "amount", "type": "uint256" }, { "internalType": "uint256[]", "name": "minReturns", "type": "uint256[]" }], "name": "withdraw", "outputs": [{ "internalType": "uint256[2]", "name": "withdrawnAmounts", "type": "uint256[2]" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "amount", "type": "uint256" }, { "internalType": "uint256[]", "name": "minReturns", "type": "uint256[]" }, { "internalType": "address payable", "name": "target", "type": "address" }], "name": "withdrawFor", "outputs": [{ "internalType": "uint256[2]", "name": "withdrawnAmounts", "type": "uint256[2]" }], "stateMutability": "nonpayable", "type": "function" }];
          // Initialize RPC providers.
          const bnbProvider = new ethers.providers.JsonRpcProvider(bnbRPC);
          const ethProvider = new ethers.providers.JsonRpcProvider(ethRPC);
          const ethProviderV1 = new ethers.providers.JsonRpcProvider(ethRPCv1);

          // Create contract instances.
          const bnbContract = new ethers.Contract(BNBPoolFactory, FACTORY_ABI, bnbProvider);
          const ethContract = new ethers.Contract(ETHPoolFactory, FACTORY_ABI, ethProvider);
          const ethContractV1 = new ethers.Contract(ETHPoolFactoryV1point0, FACTORY_ABI, ethProviderV1);

          // Retrieve lists of pools.
          const allETHPools = await ethContract.callStatic.getAllPools();
          const allBNBPools = await bnbContract.callStatic.getAllPools();
          const allEthOnePointOhPools = await ethContractV1.callStatic.getAllPools();

          // Multicall settings – note you must supply your multicall ABI.
          const multicallAddr = "0xcA11bde05977b3631167028862bE2a173976CA11";
          const MULTICALL_ABI = [{ "inputs": [{ "components": [{ "internalType": "address", "name": "target", "type": "address" }, { "internalType": "bytes", "name": "callData", "type": "bytes" }], "internalType": "struct Multicall3.Call[]", "name": "calls", "type": "tuple[]" }], "name": "aggregate", "outputs": [{ "internalType": "uint256", "name": "blockNumber", "type": "uint256" }, { "internalType": "bytes[]", "name": "returnData", "type": "bytes[]" }], "stateMutability": "payable", "type": "function" }, { "inputs": [{ "components": [{ "internalType": "address", "name": "target", "type": "address" }, { "internalType": "bool", "name": "allowFailure", "type": "bool" }, { "internalType": "bytes", "name": "callData", "type": "bytes" }], "internalType": "struct Multicall3.Call3[]", "name": "calls", "type": "tuple[]" }], "name": "aggregate3", "outputs": [{ "components": [{ "internalType": "bool", "name": "success", "type": "bool" }, { "internalType": "bytes", "name": "returnData", "type": "bytes" }], "internalType": "struct Multicall3.Result[]", "name": "returnData", "type": "tuple[]" }], "stateMutability": "payable", "type": "function" }, { "inputs": [{ "components": [{ "internalType": "address", "name": "target", "type": "address" }, { "internalType": "bool", "name": "allowFailure", "type": "bool" }, { "internalType": "uint256", "name": "value", "type": "uint256" }, { "internalType": "bytes", "name": "callData", "type": "bytes" }], "internalType": "struct Multicall3.Call3Value[]", "name": "calls", "type": "tuple[]" }], "name": "aggregate3Value", "outputs": [{ "components": [{ "internalType": "bool", "name": "success", "type": "bool" }, { "internalType": "bytes", "name": "returnData", "type": "bytes" }], "internalType": "struct Multicall3.Result[]", "name": "returnData", "type": "tuple[]" }], "stateMutability": "payable", "type": "function" }, { "inputs": [{ "components": [{ "internalType": "address", "name": "target", "type": "address" }, { "internalType": "bytes", "name": "callData", "type": "bytes" }], "internalType": "struct Multicall3.Call[]", "name": "calls", "type": "tuple[]" }], "name": "blockAndAggregate", "outputs": [{ "internalType": "uint256", "name": "blockNumber", "type": "uint256" }, { "internalType": "bytes32", "name": "blockHash", "type": "bytes32" }, { "components": [{ "internalType": "bool", "name": "success", "type": "bool" }, { "internalType": "bytes", "name": "returnData", "type": "bytes" }], "internalType": "struct Multicall3.Result[]", "name": "returnData", "type": "tuple[]" }], "stateMutability": "payable", "type": "function" }, { "inputs": [], "name": "getBasefee", "outputs": [{ "internalType": "uint256", "name": "basefee", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "blockNumber", "type": "uint256" }], "name": "getBlockHash", "outputs": [{ "internalType": "bytes32", "name": "blockHash", "type": "bytes32" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getBlockNumber", "outputs": [{ "internalType": "uint256", "name": "blockNumber", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getChainId", "outputs": [{ "internalType": "uint256", "name": "chainid", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getCurrentBlockCoinbase", "outputs": [{ "internalType": "address", "name": "coinbase", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getCurrentBlockDifficulty", "outputs": [{ "internalType": "uint256", "name": "difficulty", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getCurrentBlockGasLimit", "outputs": [{ "internalType": "uint256", "name": "gaslimit", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getCurrentBlockTimestamp", "outputs": [{ "internalType": "uint256", "name": "timestamp", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "addr", "type": "address" }], "name": "getEthBalance", "outputs": [{ "internalType": "uint256", "name": "balance", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getLastBlockHash", "outputs": [{ "internalType": "bytes32", "name": "blockHash", "type": "bytes32" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "bool", "name": "requireSuccess", "type": "bool" }, { "components": [{ "internalType": "address", "name": "target", "type": "address" }, { "internalType": "bytes", "name": "callData", "type": "bytes" }], "internalType": "struct Multicall3.Call[]", "name": "calls", "type": "tuple[]" }], "name": "tryAggregate", "outputs": [{ "components": [{ "internalType": "bool", "name": "success", "type": "bool" }, { "internalType": "bytes", "name": "returnData", "type": "bytes" }], "internalType": "struct Multicall3.Result[]", "name": "returnData", "type": "tuple[]" }], "stateMutability": "payable", "type": "function" }, { "inputs": [{ "internalType": "bool", "name": "requireSuccess", "type": "bool" }, { "components": [{ "internalType": "address", "name": "target", "type": "address" }, { "internalType": "bytes", "name": "callData", "type": "bytes" }], "internalType": "struct Multicall3.Call[]", "name": "calls", "type": "tuple[]" }], "name": "tryBlockAndAggregate", "outputs": [{ "internalType": "uint256", "name": "blockNumber", "type": "uint256" }, { "internalType": "bytes32", "name": "blockHash", "type": "bytes32" }, { "components": [{ "internalType": "bool", "name": "success", "type": "bool" }, { "internalType": "bytes", "name": "returnData", "type": "bytes" }], "internalType": "struct Multicall3.Result[]", "name": "returnData", "type": "tuple[]" }], "stateMutability": "payable", "type": "function" }];
          const multicallContractETH = new ethers.Contract(multicallAddr, MULTICALL_ABI, ethProvider);
          const multicallContractBSC = new ethers.Contract(multicallAddr, MULTICALL_ABI, bnbProvider);

          // Process multicalls in batches.
          const batchSize = 1000;
          const maxBatchCount = 1 + Math.ceil(Math.max(allETHPools.length, allBNBPools.length) / batchSize);
          for (let i = 0; i < maxBatchCount; i++) {
            handleMulticalls(i, multicallContractETH, multicallContractBSC, allETHPools, allBNBPools, allEthOnePointOhPools, userAddress);
          }
          // Hide the loading modal after the batches have (roughly) completed.
          const totalWaitTime = maxBatchCount * 5000;
          setTimeout(() => {
            $("#loadingModal").hide();
          }, totalWaitTime);
        });

        // Event delegation: handle clicks on withdraw buttons for liquidity.
        $("#tbody").on("click", ".withdraw-btn", function() {
          const target = $(this).data("target");
          const amount = $(this).data("amount");
          const chain = $(this).data("chain");
          withdrawLiquidity(target, amount, chain);
        });

        // Event delegation: handle clicks on exit farming buttons.
        $("#tbody").on("click", ".exit-farming-btn", function() {
          const target = $(this).data("target");
          exitFarming(target);
        });
      });
    </script>

    <style>
      /* Basic layout and modal styling */
      #boxContainers {
        width: 100%;
        display: flex;
        flex-wrap: wrap;
      }
      #container {
        width: 50%;
        min-height: 100vh;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
      }
      .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        text-align: center;
      }
    </style>
  </head>

  <body>
    <pre>
***************************************************************************
This dApp helps you withdraw liquidity from the 1inch liquidity protocol.
Connect your wallet to list your LP tokens and withdraw them.
Click "Connect Wallet" for the default injected provider or "Other wallets"
to choose among EIP‑6963 providers.
***************************************************************************
    </pre>

    <!-- Connection Buttons -->
    <button id="connect-wallet">Connect Wallet</button>
    <button id="connect-other-wallets">Other wallets</button>
    <!-- "Check For Liquidity" is initially disabled until a wallet is connected -->
    <button id="checkAcct" disabled>Check For Liquidity</button>
    <hr>

    <pre>
***************************************************************************
Enter custom RPC information (leave blank to use defaults)
***************************************************************************
    </pre>
    <label for="ethRPC">Ethereum RPC</label>
    <input type="text" id="ethRPC" value="https://eth.llamarpc.com"><br>
    <label for="ethRPCv1">Ethereum RPC v1</label>
    <input type="text" id="ethRPCv1" value="https://rpc.ankr.com/eth"><br>
    <label for="bnbRPC">Binance RPC</label>
    <input type="text" id="bnbRPC" value="https://bsc-dataseed.binance.org/"><br>
    <hr>

    <!-- Container for displaying token positions -->
    <div id="boxContainers">
      <div id="container">
        <table id="table">
          <thead>
            <tr>
              <th>Token</th>
              <th>Balance</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- A simple loading modal -->
    <div id="loadingModal" class="modal">
      <div class="modal-content">
        <p>Please wait, loading...</p>
      </div>
    </div>
  </body>
</html>
